% English Article template created by Vopaaz
\documentclass{article}
\usepackage{geometry}
\geometry{a4paper}
\usepackage{setspace}
\usepackage{enumerate}
\usepackage{enumitem}
\usepackage{hyperref}
\hypersetup{colorlinks,allcolors=black}

\setenumerate[1]{itemsep=0pt,partopsep=2pt,parsep=0pt ,topsep=2pt}
\setitemize[1]{itemsep=0pt,partopsep=2pt,parsep=0pt ,topsep=2pt}
\setenumerate[2]{itemsep=0pt,partopsep=2pt,parsep=0pt ,topsep=2pt}
\setitemize[2]{itemsep=0pt,partopsep=2pt,parsep=0pt ,topsep=2pt}
\setdescription{itemsep=0pt,partopsep=2pt,parsep=0pt ,topsep=2pt}

\usepackage{graphicx}
\usepackage{fontspec}

\defaultfontfeatures{%
    RawFeature={%
        % +swsh,
        +calt
    }%
}

\setmainfont{EB Garamond}

%-----------%

\usepackage{amsmath}
\usepackage{amssymb}

\usepackage[ruled, linesnumbered]{algorithm2e}

\title{Building a Stock Market Trading Agent with Genetic Algorithm}
\author{YiFan Li\\ZeYuan Yang}
\date{\today}



\begin{document}

\addfontfeatures{RawFeature={+smcp}}
\maketitle
\addfontfeatures{RawFeature={-smcp}}

%-------%

\begin{abstract}
	TODO: abstract
\end{abstract}

\section{Introduction}

Predicting the future can only happen in science fictions,
but predicting the future trend of some certain time series is feasible.
Time series analysis has a long history, and multiple approaches have been studied.

The most traditional methods are statistical ones such as the well-known ARIMA model.
Although the model is simple, it is still used in recent researches such as \cite{arima-bus-travel}.
Some delicately designed machine learning approaches are also introduced in these years,
varying from relatively simple support vector machine \cite{support-vector-machine}
to complex neural network \cite{time-series-prediction-and-neural-networks}.

The one that receives the most attention among all time series is probably the stock price.
Firstly, as an essential part of the financial market, the stock market is the apple of investors' eyes.
Not only financial researchers but also individuals and securities companies have
tried their best to analyze the stock price time series and predict its behavior in the future,
to make a fortune.
Secondly, unlike most time series prediction tasks where the output must be exact future values,
only knowing whether the future price will go up or down is already sufficient to make a trading decision.
Therefore, the problem can be simplified thus enabling more ideas and approaches to be applicable.
Thirdly, sufficient financial indexes and trading rules
can serve as domain knowledge to be combined with computer algorithms.

Nowadays, there are numerous financial indexes, and over two hundred different trading rules were
built upon them to suggest buying, selling or holding decisions,
based on historical stock price time series \cite{stock-timing-using-genetic-algorithms}.
Each rule has its rationality and will indicate some features of the target stock.
However, the movement of a stock price is the combined result of a massive number of microeconomic and macroeconomic factors,
which makes it impossible to predict the trend with any index or rule solely.
As Korczak \cite{stock-timing-using-genetic-algorithms} pointed out,
there is no rule consistently outperforming the others.
Therefore, finding the most appropriate way to utilize them becomes the key to the problem.

Although some scholars argue that stock prices follow a random walk pattern,
most experts in this field believe that the prices can be predicted with more than 50 percent accuracy,
with eligible trading rules and reasonable combination \cite{stock-market-prediction-with-multiple-classifiers}.
Plenty of approaches has been examined and we will go through some of them in the literature review.
Noticeably, the genetic algorithm is widely used in related researches.

% for instance, neutral networks used by Kimoto et al \cite{stock-market-prediction-system-with-modular-neural-networks}.
% Genetic algorithm is one of them as well.

Genetic algorithm is an adaptive heuristic search method,
inspired by the natural process of genetic evolution.
It can quickly generate high-quality solutions to optimization problems, such as scheduling and shortest path,
and modeling system where randomness is involved, such as the stock market,
by simulating the selection, crossover and mutation procedures in nature
\cite{genetic-algorithm-review-and-application}.

In our paper, we will apply the genetic algorithm to
find the best combination of a set of trading rules, which can help with the buy and sell decisions.
We will dig deeper into a more comprehensive and applicable solution based on the previous works.

% Implementation details, could be useful in Section Method.

% ---------------- %
% We base on a historical stock price time series in the past \emph{n} periods
% to build an agent to make a final decision of buying and selling.
% % TODO: how many
% More than 10 different financial rules and historical prices information
% in the past three years of 5 stocks are included by us to build our experiment.

% Our experiment is designed to predict the stock price as a search problem.
% Every rule is assigned a weight.
% All these weights constitute a vector, a new, combination rule to predict the prices.
% Each vector is considered as a chromosome.
% Running the genetic algorithm on this, we program to find the optimal prediction rule for stocks.
% The final selected agent is considered to have the capacity to make the most optimal buying and selling decisions.

% The experiment is conducted in two phases.
% We divide our dataset into two subsets, a train dataset, and a test dataset.
% In the first stage, we will only use the train dataset to find the hyperparameters that lead to the best performance here.
% In the second stage, the genetic algorithm will be run on the test dataset to measure performance.
% By this approach, we not only find the optimal solution but also avoid the over-fitting problem.

% In the following section,
% we describe what other researchers have done regarding the prediction in the stock market,
% especially using a genetic algorithm.

% ---------------- %


\section{Related Work}

We will go through related works about the genetic algorithms first,
then look into its application on the stock time series prediction.

\subsection{Genetic Algorithm}

The genetic algorithm was invented in the early 1970s by John Holland \cite{genetic-algorithm-review-and-application}.
It is based on the mechanics of natural genetic selection.
To conduct GA, a ``chromosome'' must be defined to represent a solution to the problem.
A chromosome is a sequence of alleles, such as a bit.
The genetic features of such representation enable crossover and mutation,
in order to exchange information with each other \cite{an-object-oriented-environment-for-specification}.
A fitness function, which can evaluate the solution, has to be defined as well.
It will be used to select those chromosomes that survive.

The general steps of the genetic algorithm are as follows:
\begin{enumerate}
    \item Initialization. Some chromosomes are randomly generated to form a population.
    \item Selection. During each generation, a proportion of the existing population will be selected
        through a process, where fitter solutions, measured by the fitness function, are more likely to be selected. They are used to generate the population for the next generation.
    \item Reproduction. A second generation population is bred by the previous generation. There are typically
        two genetic operators involved in this step:
        \begin{enumerate}
            \item Crossover. Parent chromosomes are selected from the survivors and their genes are combined in some certain way
                to create a new chromosome.
            \item Mutation. Some genes in some chromosomes are randomly chosen and changed.
        \end{enumerate}
        Generally, the population size is preserved throughout each generation,
        so the selection and reproduction process should counterbalance each other's effect on the number of chromosomes.
    \item Termination. The selection and reproduction are repeated several times until a termination condition has been reached.
        Common termination conditions can be:
        \begin{enumerate}
            \item A solution is found which satisfies a minimum fitness criteria
            \item A fixed number of iteration is reached
            \item The fitness value of the best chromosomes in several successive generations is not improving
        \end{enumerate}
\end{enumerate}

As the genetic algorithm keeps developing, several variants are proposed.
The first one is the chromosome representation.
Traditionally, the chromosome consists of a series of binary bits.
However, in some problem settings, the gene can be a floating-point number
\cite{an-experimental-comparison-of-binary-and-floating}, or even complex data structures like
list or map \cite{helga-a-heterogeneous-encoding}.
The second one is elitism \cite{removing-the-genetics-from-the-standard-genetic-algorithm},
which requires the selection and reproduction to be carefully designed so that
the several best chromosome must be preserved to the next generation.
The third one is the adaptive genetic algorithm \cite{adaptive-probabilities-of-crossover-and-mutation}.
Unlike the traditional ones whose strategy of selection and reproduction is constant,
the possibility of selection, crossover, and mutation will vary in adaptive GA.
The adjustment of these possibilities is related to the current fitness value.
All these variants improved some aspect of the genetic algorithm,
and we will implement some of them in our experiment.


\subsection{Application of GA to Stock Price Prediction}

Given the stock price time series as the original data,
Stephen Leung et al. \cite{a-novel-stock-forecasting-model-based-on-fuzzy-time-series}
modeled it as a fuzzy time series
by converting the percentage of the price change into a fuzzy value.
The fuzzy logic relationship is extracted and classified to form fuzzy logic relationship groups (FLRGs).
FLRGs will then be normalized to get a weight matrix.
Each gene in the chromosome corresponds to a fuzzy value
and the whole chromosome will output a prediction.
The fitness function used in the genetic algorithm is:
$$
\text{RMSE} =
\sqrt{ \dfrac {\sum \limits_{t=1}^{n}\left(\operatorname{actual}(t) - \operatorname{predicted}(t)\right)^2 } {n}}
$$

One technique in their approach is worth mentioning.
The tournament method is used to select survivors in the previous generation.
Several ``tournaments" among a few chromosomes chosen at random from the population are conducted.
The winner of each tournament (the one with the best fitness) is selected for crossover.
Comparing with the traditional approach of directly selecting the good ones from the whole population,
it can improve gene diversity thus prevent GA from being trapped in local optimum
\cite{a-note-on-boltzmann-tournament-selection}.

Applying the fuzzy logic as well, Kuo, Ren Jie and his team \cite{an-intelligent-stock-trading-decision-support-system}
further choose to combine genetic and neural networks.
They developed a stock trading system, using GFNN (genetic-algorithm-based fuzzy neural networks)
to build the qualitative model.
The basic model is an FNN (fuzzy neural network), and
the genetic algorithm is used to provide the initial weights and select hyperparameters.
This research and some similar ones utilized the optimization feature of the genetic algorithm,
but put more emphasis on other techniques.

In addition to those combining multiple methodologies to build a complex model
without the help of domain knowledge,
more studies use only GA as the algorithm and take the financial indexes and trading rules into account.
They no longer produce exact value for future time series but provide trading decisions.
As we mentioned before, there are numerous financial indexes,
each summarizing one feature of the stock price time series.
They can be used to build trading rules, which will indicate a decision for buying, selling or holding.
It is the strategy to utilize them that is optimized in those researches.
However, the way they model the problem setting may be slightly different.

Lin Li et al. \cite{the-applications-of-genetic-algorithms-in-stock-market-data-mining}
arbitrarily picked one trading rule, ``the filter rule", and optimize the choice of its parameters.
The fitness function is the profit of trading using its decision.
Comparing with brute force grid search, genetic algorithm saved a lot of running time,
but loses very little precision.
Nevertheless, only using one trading rule limits the model's performance, hence
the profit is still significantly lower than that of a human trader.
Most studies are focused on the way of combining multiple financial indexes.

Fuentu et al. \cite{genetic-algorithms-to-optimise-the-time-to-make-stock-market-investment} selected
three financial indexes, RSI, MACD, and Stochastic Index,
and five of their variants are coded in the algorithm.
The goal is to find the best time to buy stock, indicated by the values of the five index variants.
Each gene in the chromosome represents an interval of the value of a financial index,
and the fitness function is calculated as below:
\begin{enumerate}
\item If there is a period that could match all the financial indexes represented by the chromosome,
    the chromosome's fitness value is the profit of making the buying decision at the start of that period.
\item If there is no such period, the chromosome will not be selected into the next generation.
\end{enumerate}
In the future, when the five financial indexes have the value represented by the best chromosome,
it can be concluded to be the best time to buy a stock.


In some other researches
\cite{genetic-algorithms-for-predicting-the-egyptian-stock-market}
\cite{stock-timing-using-genetic-algorithms}
, the suggestions of trading rules are integrated to give a final trading decision
and such integration is optimized with the genetic algorithm.

Firstly, a set of representative trading rules are selected to examine,
such as Moving Average and Relative Strength Index.
Each gene in the chromosome corresponds to one rule,
with only 1 and 0 as their possible values
representing whether the rule should be considered in the final decision.
The final decision is the voting result of all the rules considered.
On each day in the stock time series, the chromosome will give such a final decision,
and the fitness function is the profit made by these decisions.
After that, a general genetic algorithm can be applied to find the best chromosome.

This approach is intuitive and relatively easy to implement.
Rohit and Kumkum \cite{a-hybrid-machine-learning-system-for-stock-market-forecasting}
take advantage of it and further uses support vector machine
to determine the weight of each rule in the final decision.

Two concerns about this approach are raised, though.
Firstly, the previous experiments are always run on one stock.
Whether this methodology is suitable for more stocks in the market remains a problem
\cite{genetic-algorithms-for-predicting-the-egyptian-stock-market}.
Secondly, whether the resulting chromosome, i.e. combination of trading rules,
remains useful as time goes by is unknown.
Some experts argue that the influence of time is not obvious,
but it still requires examination
\cite{stock-timing-using-genetic-algorithms}.
Our work will be based on the approach introduced above,
try to address these two issues and hopefully find other insights.

\section{Approach}

\subsection{Problem Setting Specification}

Similar to \cite{genetic-algorithms-for-predicting-the-egyptian-stock-market}
and \cite{stock-timing-using-genetic-algorithms},
we will setup our problem setting as follows:
\begin{itemize}
	\item Given a historical stock price time series in the past $n$ periods, $P_t=\left[p_{t-n}, p_{t-n+1}, \cdots, p_{t-1}\right]$,
	      where $t$ represents the present,
	\item and a set of $k$ trading rules suggesting ``buy", ``sell" or ``hold" action based on the time series\\
	      $R=\{r_1, r_2, \cdots, r_k\}, \forall r_i(P_t) \rightarrow s_i \in \{\text{sell}, \text{buy}, \text{hold}\}$,
	\item design an agent $A$ who can integrate all the rules to make a final decision\\
	      $A(R(P_t)) \rightarrow d_t \in \{\text{sell}, \text{buy}, \text{hold}\}$,
	\item that can generate profit in the following $m$ period,
	      which can be calculated as $\sum \limits_{t=0}^{m} p_{t}^{\text{sell}} - p_{t}^{\text{buy}}$,\\
	      $p_{t}^{\text{sell}} = \left\{
		      \begin{array}{ll}
			      p_t \quad & \text{if} A(R(P_t)) = \text{sell} \wedge A \text{ currently holds the stock} \\
			      0 \quad   & \text{otherwise}
		      \end{array}\right.,\\
		      p_t^{\text{buy}} = \left\{
		      \begin{array}{ll}
			      p_t \quad & \text{if} A(R(P_t)) = \text{buy} \wedge A \text{ currently not holds the stock} \\
			      0 \quad   & \text{otherwise}
		      \end{array}
		      \right.$
\end{itemize}

As examining only one stock may be not representative enough,
we will conduct the experiment on five stocks and take their average result.
Additionally, because the maximum possible benefit varies for different stock price time series,
it is unwise to compare the absolute value of profit directly.
The benchmark of our evaluation is an agent who can ``predict the future".
It knows the whole time series and make decision based on it,
$A'(P_m, t) \rightarrow d'_t$,
which can be implemented with the following trivial algorithm.

\begin{algorithm}[H]
	\KwData{prices}
	\KwData{today}
	\SetKwData{prices}{prices}
	\SetKwData{today}{today}
	\KwResult{decision}

	\uIf{$\prices[\today+1] > \prices[\today]$}{
		\Return{buy}\;
	}\uElseIf{$\prices[\today+1] < \prices[\today]$}{
		\Return{sell}\;
	}\Else{
		\Return{hold}\;
	}
	\caption{Benchmark Agent}
\end{algorithm}

In all, the evaluation of the agent will be
$
\dfrac{\sum \limits_{i=1}^{5}
\dfrac{
    \operatorname{Profit}_i(\text{genetic agent})
}{
    \operatorname{Profit}_i(\text{benchmark agent})
}}{5}$, where $i$ represents different stocks, and the goal is to maximize it.


\subsection{Genetic Algorithm}

\subsubsection{Chromosome Representation}

In our experiment, each gene in the agent's chromosome will be a number
\footnote{In the complex representation variant,
a part of the gene will be a number.
See section \ref{subsubsec-variants} for detail.}
corresponding to one trading rule.
It will be used as the weight to take average on the trading rules' decision.
The decisions can be considered as:
\begin{itemize}
	\item Buy $\rightarrow$ 1
	\item Sell $\rightarrow$ -1
	\item Hold $\rightarrow$ 0
\end{itemize}

After that, a positive weighted average will be result in a Buy decision,
while a negative one will lead to a Sell decision outputted by the agent.

\subsubsection{Genetic Operators}

Various implementations for genetic algorithm operators are proposed in previous works.
For example, there are trivial highest-score selection and tournament
method\cite{a-note-on-boltzmann-tournament-selection},
single-point, k-point and uniform crossover\cite{genetic-algorithm-review-and-application}, etc.
Therefore we considered it necessary to describe
our implementation of the genetic operators explicitly.

We applied the basic highest-score selection,
which selects a percentage of agents with the highest score to go to the reproduction process.

In the crossover phase, a percentage of agents who passed the selection will be chosen.
They will act as parents, producing new agents, but themselves will not go to the next generation.
The children and those who are not selected as parents will go to the mutation phase.
When generating new agent, uniform crossover will run repeatedly,
until the total number of agent is the same as original.
Uniform crossover, to be more specific, means that each gene in the children's chromosome
is chosen from either parent with equal probability.

During mutation, a percentage of the agents will be chosen to mutate,
the others will remain unchanged.
Each gene in the chromosome of mutating agents will have a 50\% chance to be reset as random one.

\subsubsection{Variants}\label{subsubsec-variants}

Two variants are applied in our experiment, chromosome representation and elitism.
Besides the bit (1 or 0) representation used in \cite{genetic-algorithms-for-predicting-the-egyptian-stock-market}
and \cite{stock-timing-using-genetic-algorithms}



\subsection{Other Technical Details}

\subsubsection{Data Preparation}

The open, high, low, close price and trading volume
of the five randomly chosen stocks, CMS, MKC, MMP, THS and XEL,
between 2016-01-04 and 2018-12-31 are pulled from \href{https://www.alphavantage.co/}{Alpha Vantage}.
They will be used as our dataset.
The data quality is good, therefore no further preprocessing is required.

\subsubsection{Programming Details}

We chose Python as the programming language it's simple.
Its Pandas and Numpy packages also significantly simplify array and matrix computation.
There are also various modules providing fundamental framework for genetic algorithm,
however, we decide not to use them and build the genetic algorithm related modules from scratch,
because we want to know the exact details of every single line of code
in the genetic algorithm.



\bibliographystyle{abbrv}
\bibliography{report}


%-------%



\end{document}



